- name: Create system user
  user: 
    name: "{{ app_user }}"
    system: true
    shell: /usr/sbin/nologin

- name: Create working directory
  file: 
    path: "{{ app_dir }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: "0755"

- name: Copy application code
  copy: 
    src: files/app.txt
    dest: "{{ app_dir }}/app.txt"
    owner: "{{ app_user }}"
    group: "{{ app_user }}"
    mode: "0644"

- name: Create environment file
  copy:
    dest: "{{ env_file }}"
    content: |
      APP_PORT={{ app_port }}
      APP_HOST={{ app_host }}
      APP_DATABASE_URL={{ app_database_url }}
      APP_ENV={{ app_env }}
    mode: "0644"

- name: Install systemd
  template:
    src: todo-api.service.j2
    dest: /etc/systemd/system/{{ service_name }}.service
    mode: "0644"

- name: Reload systemd daemon
  systemd: 
    daemon_reload: true

- name: Enable and start service
  systemd: 
    name: "{{ service_name }}"
    state: started
    enabled: true

- name: Install UFW
  apt:
    name: ufw
    state: present
    update_cache: true

- name: Allow SSH
  ufw: 
    rule: allow
    name: OpenSSH

- name: Allow app port
  ufw: 
    rule: allow
    port: "{{ app_port }}"
    proto: tcp

- name: Enable UFW
  ufw:
    state: enabled